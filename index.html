<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- <link href="http://designmodo.github.io/Flat-UI/bootstrap/css/bootstrap.css" rel="stylesheet"> -->
        <link href="css/flat-ui.css" rel="stylesheet">
        <style>
            body {
                font-family: Quicksand;
                font-weight: 300;                
            }
            
            header {
               font-size: 46px;
               color:#2d8fc1;
               text-align: left;               
            }
            header a:visited {color:none;}
            header a {text-decoration:none; color:#2d8fc1}
                        
            .file {
              width: 350px;
            }
            .file-button{
                border-radius: 4px;
                background: #2d8fc1;;
                padding: 22px 30px;
                color: #fff;
                font-size:24px;
                cursor: pointer;
            }
            .file label {
              float:left;
            }
            .file input {
              position: absolute;
              display: inline-block;
              left: 0;
              top: 0;
              opacity: 0.01;
              cursor: pointer;
            }        
            #showData {
                visibility: hidden;
            }            
            
            section {
                margin: 0px;
                padding: 0px;
                display: -webkit-flex;
                display:         flex;
                -webkit-flex-flow: row;
                   flex-flow: row;
            }

            section#top {
                min-height: 225px;
            }
            
            section#middle {
                margin-top: 15px;
                min-height: 600px;
            }
            
            .panel {
                margin: 20px;
                padding: 5px;
                border: 1px solid rgb(230,230,230);
                border-radius: 2pt;
                text-align: center;
            }
            
            .panel > .title { font-size: 30px}

            .panel#read-depth {
                -webkit-flex: 3 1 80%;
                   flex: 3 1 80%;
                -webkit-order: 1;
                   order: 1;
                height: 225px;
            }

            .panel#total-reads {
                -webkit-flex: 1 5 20%;
                   flex: 1 5 20%;
                -webkit-order: 2;
                   order: 2;
            }
            
            #percents {
                margin-right: 20px;
                -webkit-flex: 1 4 40%;
                   flex: 1 4 40%;
                -webkit-order: 1;
                   order: 1;
                display: -webkit-flex;
                -webkit-flex-direction: row;
                -webkit-flex-wrap: wrap;
            }
            
            
            #distributions {
                -webkit-flex: 1 2 60%;
                   flex: 1 2 60%;
                -webkit-order: 2;
                   order: 2;
                display: -webkit-flex;
                -webkit-flex-direction: row;
                -webkit-flex-wrap: wrap;
            }
            

            .checkbox.checked, .checkbox.checked .icons{ color: #267FAD;}
            .checkbox {padding-left: 18px;}
            .checkbox, .checkbox .icons{ 
                height: 13px;
                line-height: 13px;
                font-size: 13px;
            }
            
            
            #percents .percent {-webkit-flex: 1 1 30%}
            #percents .percent svg { width: 100%; height:100%;}            
            #distributions .distribution {-webkit-flex: 1 1 100%; height:200px}
            
            .regionBar rect {
              fill: #33A7E4;
              shape-rendering: crispEdges;
            }
            
            .sampleBar rect {
              fill: #2687BE;
              shape-rendering: crispEdges;
            }
            

            .bar text {
              fill: 'black';
            }

            .axis path, .axis line {
              fill: none;
              stroke: #000;
              shape-rendering: crispEdges;
            }
            
            .sampleArc .fill {fill: #2687BE} 
            .regionArc .fill {fill: #33A7E4}
            

/*                        .regionArc .fill {fill: #36B3F4}            */
            .alpha {fill: rgba(45,143,193,0.2);}

            .regionColor {
                fill : #33A7E4;
                color: #33A7E4;
            }
            
            .sampleColor {
                font-weight: 400;
                fill : #2687BE;
                color: #2687BE;
            }
            
            .arrow_box {
            	position: relative;
            	background: #ffffff;
            	border: 2px solid #2d8fc1;
            	border-radius: 4px;
            }
            .arrow_box:after, .arrow_box:before {
            	bottom: 100%;
            	border: solid transparent;
            	content: " ";
            	height: 0;
            	width: 0;
            	position: absolute;
            	pointer-events: none;
            }
            .arrow_box:after {
                border-color: rgba(255, 255, 255, 0);
                border-bottom-color: #ffffff;
                border-width: 20px;
                left: 78%;
                margin-left: -20px;
            }
            .arrow_box:before {
                border-color: rgba(45, 143, 193, 0);
                border-bottom-color: #2d8fc1;
                border-width: 23px;
                left: 78%;
                margin-left: -23px;
            }                          
            .arrow_box input {
                border: none;
                outline: none;
                width:510px;
                margin: 8px;
                color: #2d8fc1;
                font:300 30px quicksand;
            }
            .arrow_box button { font:300 28px quicksand;}

            /* Too narrow to support three columns */
            @media all and (max-width: 640px) {

                #top, #page {
                    -webkit-flex-flow: column;
                        flex-flow: column;
                }

                #read-depth, #total-reads {
                    /* Return them to document order */
                    -webkit-order: 0;
                        order: 0;
                }

                #total-reads {
                    min-height: 50px;
                    max-height: 50px;
                }
            }

        </style>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="js/class.js"></script>
        <script src="js/d3.v3.min.js"></script>
        <script src="js/donut.d3.js"></script>
        <script src="js/histogram.d3.js"></script>
        <script src="js/bam.d3.js"></script>
        <script src="js/bam.iobio.js"></script>
        <script src="js/bam.js"></script>
        <script src="js/bin.js"></script>
        <script src="js/inflate.js"></script>
        <script src="js/binary.js"></script>
        <link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
        
        <script>
            $(document).ready( function(){
                var is_chrome = navigator.userAgent.toLowerCase().indexOf('chrome') > -1;
                if (!is_chrome) alert("Warning! This site requires Google Chrome to function properly");
                // check for window.requestAnimation frame and add it if it's not here.
                (function () {
                  var lastTime = 0;
                  var vendors = ['ms', 'moz', 'webkit', 'o'];
                  for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
                    window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];
                    window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame'] || window[vendors[x] + 'CancelRequestAnimationFrame'];
                  }
                  if(!window.requestAnimationFrame)
                    window.requestAnimationFrame = function (callback, element) {
                      var currTime = new Date().getTime();
                      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
                      var id = window.setTimeout(function () {
                        callback(currTime + timeToCall);
                      },
                      timeToCall);
                      lastTime = currTime + timeToCall;
                      return id;
                  };
                  if(!window.cancelAnimationFrame)
                    window.cancelAnimationFrame = function (id) {
                      clearTimeout(id);
                  };
                }());
                
                $("#fragment-length-distribution input[type='checkbox']").change(function(){
                    if ($(this).parent().hasClass("checked")) {
                        window.fragChart(hist2array(window.sampleStats.frag_hist), undefined, { 'klass' : 'sampleBar'})
                        window.fragChart(hist2array(window.regionStats.frag_hist), undefined, { 'klass' : 'regionBar'})
                    } else {
                        window.fragChart(hist2array(window.sampleStats.frag_hist), undefined, { 'klass' : 'sampleBar', noOutliers : true })
                        window.fragChart(hist2array(window.regionStats.frag_hist), undefined, { 'klass' : 'regionBar', noOutliers : true })
                    }
                });
                
                $('#url-input').focus(function() {
                    if (this.setSelectionRange) {
                        this.setSelectionRange(7, 7);
                    } else if (this.createTextRange) {
                        // IE
                        var range = this.createTextRange();
                        range.collapse(true);
                        range.moveStart('character', 7);
                        range.moveEnd('character', 7);
                        range.select();
                    }
                });
                
                document.getElementById('file').addEventListener('change', openBamFile, false);
                
                
                // initialize charts
                window.fragChart    = histogramD3("#fragment-length-distribution");
                window.readLengthChart    = histogramD3("#read-length-distribution");
                window.mapQualChart = histogramD3("#mapping-quality-distribution");
                window.readRegionChart = bamD3("#read-depth", 0.85, '#33A7E4');
                window.sampleDonutChart = donutD3().radius(61).klass("sampleArc");
                window.regionDonutChart = donutD3().radius(70).klass("regionArc");
                
                // hold onto stats
                window.sampleStats = undefined;
                window.regionStats = undefined;
                
                window.bam = undefined;
                
            });
            
            function openBamFile(event) {
                
                if (event.target.files.length != 2) {
                   alert('must select both a .bam and .bai file');
                   return;
                }

                var fileType0 = /[^.]+$/.exec(event.target.files[0].name)[0];
                var fileType1 = /[^.]+$/.exec(event.target.files[1].name)[0];

                if (fileType0 == 'bam' && fileType1 == 'bai') {
            	    bamFile = event.target.files[0];
            	    baiFile = event.target.files[1];
            	 } else if (fileType1 == 'bam' && fileType0 == 'bai') {
            	    bamFile = event.target.files[1];
            	    baiFile = event.target.files[0];
            	 } else {
            	    alert('must select both a .bam and .bai file');
            	 }
            	 
            	 window.bam = new Bam( bamFile, { bai: baiFile });
            	 
            	 goBam();
              } 
              
             function goBam() {
                 $("#selectData").css("display", "none");
                 $("#showData").css("visibility", "visible")
                 
                 // get sample stats
                 window.bam.sampleStats(11, function(data){ 
                    window.sampleStats = data;
                    updatePercentCharts(data, window.sampleDonutChart)
                    updateTotalReads(data.total_reads);
                    updateHistogramCharts(data, undefined, "sampleBar")
                 });
                 
                 // get region stats
                 window.bam.stats(getChr(), getMin(), getMax(), function(data){ 
                     window.regionStats = data;
                     updatePercentCharts(data, window.regionDonutChart)
                     updateHistogramCharts(data, undefined, "regionBar")
                 });
             } 
                                
            
            function resetRegionStats() {
                window.regionStats = {'Total reads' : {number : 0}};
            }
                                    
            function getChr() {
                return 11;
            }
            
            function getMin() {
                return 10108473;
            }
            
            function getMax() {
                return 10198473;
            }
            
            function getReference() {
                return window.references[11];
            }
                                    
            function updateTotalReads(totalReads) {
                // update total reads
                var reads = shortenNumber( totalReads );
                $("#total-reads>#value").html( reads[0] );
                $("#total-reads>#base").html( reads[1] || "" );
            }
            
            function updatePercentCharts(stats, donutChart) {
                var pie = d3.layout.pie()
                   .sort(null);
                var value = undefined;
                
                //update percent charts
                var keys = ['mapped_reads', "proper_pairs", "forward_strands", "singletons", "both_mates_mapped", "duplicates"]
                var colors = ["rgb(45,143,193)", 'rgb(231, 76, 60)', "rgb(243, 156, 18)", "rgb(155, 89, 182)", "rgb(46, 204, 113)", "rgb(241, 196, 15)"];
                keys.forEach( function(key,i) {
                    var stat = stats[key];                    
                    var data = [ stat, stats['total_reads'] - stat ];
                    var arc = d3.select('#'+key + " svg").selectAll("." + donutChart.klass())
                        .data(pie(data));
                    donutChart(arc, colors[i]);                  
                });
                
            }
            
            function updateHistogramCharts(histograms, otherMinMax, klass) {
                // update fragment length distribution                
                window.fragChart(hist2array(histograms.frag_hist), otherMinMax, { 'klass' : klass, noOutliers : true })
                    
                // update fragment length distribution
                window.readLengthChart(hist2array(histograms.length_hist), otherMinMax, { 'klass' : klass })
                
                // update fragment length distribution
                window.mapQualChart(hist2array(histograms.mapq_hist), otherMinMax, { 'klass' : klass })
                    
                // update read depth histogram
                if (klass == 'regionBar') {
                    // add absolute position information
                    var a = [];
                    var binSize = parseInt((getMax() - getMin()) / 256);
                    var binPos = 0;
                    for ( var i in histograms.base_coverage) {                            
                        var binPos = parseInt(i);
                        var instances = histograms.base_coverage[i];
                        a.push( {position:getMin() + binPos * binSize, length: instances/binSize} );
                        binPos += 1;
                    }
                    window.readRegionChart(a, { minMax : [getMin(), getMax()], numBins: 20 } );
                }
            }
            
            function shortenNumber(num) {
                if(num.toString().length <= 3)
                    return [num];
                else if (num.toString().length <= 6)
                    return [Math.round(num/1000), "thousand"];
                else
                    return [Math.round(num/1000000), "million"];
            }
                        
            function hist2array(hist) {
                var a = [];
                for ( var i in hist) {
                    var position = i;
                    var instances = hist[i];
                    for ( var j=0; j < instances; j++)
                        a.push( parseInt(position) );
                }
                return a;
            }
                        
            function displayBamUrlBox() {
                $('#bam-url').css('visibility','visible');
                $("#bam-url").children("input").focus();
            }
            
            function openBamUrl() {
                window.bam = new Bam( $("#url-input").val() );
                goBam();
            }
            
            
        </script>
    </head>
    <body>
        <header><a href="http://bam.iobio.io">bam<span style="color:rgb(200,200,200)">.iobio.io</span></a></header>
        <div id="selectData">
            <!-- <input type="file" id="files" name="files[]" multiple /> -->
            <div style="width:600px; margin-left:auto; margin-right:auto; margin-top: 200px">
                <div class="file" onClick="$('#bam-url').css('visibility', 'hidden')">
                    <input type="file" name="files[]" id="file"  multiple />
                    <label class="file-button" for="file" >Choose Bam File</label>
                </div>
                <div class="file-button" style="float:right" onClick="displayBamUrlBox()">Choose Bam Url</div>
                <div style="clear:both"></div>
            </div>
            <div id='bam-url' style="margin-top:24px;width:600px;margin-left:auto;margin-right:auto;visibility:hidden" class="arrow_box">
                <input id="url-input" value="http://s3.amazonaws.com/1000genomes/data/NA06984/alignment/NA06984.chrom11.ILLUMINA.bwa.CEU.low_coverage.20111114.bam" ></input><button onClick="openBamUrl()">Go</button>
            </div>
            
            <!-- <span>Chromosome </span><input id="chromosome" value="11"/>
            <span style="margin-left: 10px">Start Pos </span><input id="startpos" value="10108473"/>
            <span style="margin-left: 10px">End Pos </span><input id="endpos" value="10198473"/>
            <button onClick="testBam()" style="margin-left: 10px">Test Bam</button> -->
        </div>
        <div id="showData">
            <section id="top">
                <div id="read-depth" class="panel">
                    <div class="title">Reads</div>
                    <!-- <div id="read-region"></div>
                    <div id="read-sample"></div> -->
                </div>
                <div id="total-reads" class="panel">
                    <div class="title">Reads Sampled</div>
                    <div id="value" style="font-size:7vw; color:#2687BE; text-align:center;padding-left:8px;">0</div>
                    <div id="base" style="font-size:1.4vw; letter-spacing:2px; color:#2687BE; text-align:center;padding-left:8px;margin-top:-17px"></div>
                </div>
            </section>
            <div style="width:200px;margin-top:10px; margin-left: auto; margin-right:auto"> 
                <div style="display:inline-block;width:15px; height:12px; background:#33A7E4;border-radius:2px; margin-left: -20px;"></div> Region
                <div style="display:inline-block;width:15px; height:12px; background:#2687BE;border-radius:2px;margin-left: 10px;"></div> Sampled
            </div>
            <section id="middle">
                <div id="percents">
                    <div id="mapped_reads" class="percent panel">Mapped Reads
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                    <div id="forward_strands" class="percent panel">Fwd/Rev Strand
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                    <div id="proper_pairs" class="percent panel">Proper Pairs
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                    <div id="singletons" class="percent panel">Singletons
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                    <div id="both_mates_mapped" class="percent panel">Both Pairs Mapped
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                    <div id="duplicates" class="percent panel">Duplicates
                        <svg viewBox="0 0 225 149" preserveAspectRatio="xMinYMin"></svg>
                    </div>
                </div>
                <div id="distributions" >
                    <div id="fragment-length-distribution" class="distribution panel"><div>Fragment Length Distribution</div>
                        <label class="checkbox" for="checkbox2" style="float:right;margin-right:5px;cursor:pointer" >
                            <input type="checkbox"value="" id="checkbox2" data-toggle="checkbox" >
                            Outliers
                        </label>
                    </div>
                    <div id="read-length-distribution" class="distribution panel"><div>Read Length Distribution</div></div>
                    <div id="mapping-quality-distribution" class="distribution panel"><div>Mapping Quality Distribution</div></div>
                </div>
            </section>        
        </div>
        <script src="js/flatui-checkbox.js"></script>
    </body>
</html>